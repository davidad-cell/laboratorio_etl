import requests
import pandas as pd
from typing import Dict, Any
from pymongo import UpdateOne
from sqlalchemy import text
from sqlalchemy.dialects.mysql import insert
from app.database import get_mongo_client, get_mysql_engine
from app.models.personajes_sql import PersonajeDisney, Base

class ETLService:
    def __init__(self):
        self.api_url = "https://api.disneyapi.dev/character"
        self.mongo_db = get_mongo_client()
        self.mysql_engine = get_mysql_engine()
        self.collection_name = "personajes_raw"
        self.meta_collection = "etl_meta"   # colección auxiliar para guardar estado

    
    # Extracción con control de paginación
    
    async def extraer_datos_api(self, cantidad: int) -> Dict[str, Any]:
        try:
            if cantidad <= 0:
                return {
                    "mensaje": "La cantidad debe ser mayor a 0",
                    "registros_guardados": 0,
                    "fuente": "Disney API",
                    "status": 400
                }

            registros_guardados = 0
            collection = self.mongo_db[self.collection_name]
            meta = self.mongo_db[self.meta_collection]

 # Recuperar última página procesada
            ultima_pagina_doc = meta.find_one({"_meta": "ultima_pagina"})
            pagina = ultima_pagina_doc["pagina"] + 1 if ultima_pagina_doc else 1

            while registros_guardados < cantidad:
                response = requests.get(f"{self.api_url}?page={pagina}", timeout=30)
                response.raise_for_status()
                data = response.json()
                personajes = data.get("data", [])

                if not personajes:
                    break

                operaciones = []
                for personaje in personajes:
                    if registros_guardados >= cantidad:
                        break

                    personaje_id = personaje.get("_id") or personaje.get("id")
                    operacion = UpdateOne(
                        {"_id": personaje_id},
                        {"$set": personaje},
                        upsert=True
                    )
                    operaciones.append(operacion)
                    registros_guardados += 1

                if operaciones:
                    collection.bulk_write(operaciones)
                    print(f"   Página {pagina}: {len(operaciones)} personajes procesados")

                pagina += 1
           